<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Single-Molecules Bits - fluorescence</title>
        <link rel="stylesheet" href="http://tritemio.github.io/smbits/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://tritemio.github.io/smbits/">Single-Molecules Bits  <strong>Of scientific computing and single molecules.</strong></a></h1>
                <nav><ul>
                    <li><a href="http://tritemio.github.io/smbits/pages/about.html">About</a></li>
                    <li><a href="http://tritemio.github.io/smbits/category/scientific-computing.html">Scientific Computing</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://tritemio.github.io/smbits/2015/12/06/optimize-burst-search-python/">Optimizing burst search in&nbsp;python</a></h1>
<footer class="post-info">
        <abbr class="published" title="2015-12-06T00:00:00-08:00">
                Published: Sun 06 December 2015
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="http://tritemio.github.io/smbits/author/antonino-ingargiola.html">Antonino Ingargiola</a>
        </address>
<p>In <a href="http://tritemio.github.io/smbits/category/scientific-computing.html">Scientific Computing</a>.</p>
<p>tags: <a href="http://tritemio.github.io/smbits/tag/python.html">python</a> <a href="http://tritemio.github.io/smbits/tag/optimization.html">optimization</a> <a href="http://tritemio.github.io/smbits/tag/numpy.html">numpy</a> <a href="http://tritemio.github.io/smbits/tag/cython.html">cython</a> <a href="http://tritemio.github.io/smbits/tag/numba.html">numba</a> <a href="http://tritemio.github.io/smbits/tag/burst-search.html">burst-search</a> <a href="http://tritemio.github.io/smbits/tag/smfret.html">smFRET</a> <a href="http://tritemio.github.io/smbits/tag/single-molecule.html">single-molecule</a> <a href="http://tritemio.github.io/smbits/tag/fluorescence.html">fluorescence</a> </p>
</footer><!-- /.post-info --><style type="text/css">/*!
*
* IPython notebook
*
*/.ansibold{font-weight:700}.ansiblack{}.ansired{color:#8b0000}.ansigreen{6400}.ansiyellow{color:#c4a000}.ansiblue{8b}.ansipurple{color:#9400d3}.ansicyan{color:#4682b4}.ansigray{color:gray}.ansibgblack{background-}.ansibgred{background-color:red}.ansibggreen{background-color:green}.ansibgyellow{background-color:#ff0}.ansibgblue{background-f}.ansibgpurple{background-color:#ff00ff}.ansibgcyan{background-ff}.ansibggray{background-color:gray}div.cell{border:1px solid transparent;display:-webkit-box;-webkit-box-orient:vertical;display:-moz-box;-moz-box-orient:vertical;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;border-radius:2px;box-sizing:border-box;-moz-box-sizing:border-box;border-width:thin;border-style:solid;width:100%;padding:5px;margin:0;outline:0}div.cell.selected{border-color:#ababab}@media print{div.cell.selected{border-color:transparent}}.edit_mode div.cell.selected{border-color:green}.prompt{min-width:14ex;padding:.4em;margin:0;font-family:monospace;text-align:right;line-height:1.21429em}div.inner_cell{display:-webkit-box;-webkit-box-orient:vertical;display:-moz-box;-moz-box-orient:vertical;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1}@-moz-document url-prefix(){div.inner_cell{overflow-x:hidden}}div.input_area{border:1px solid #cfcfcf;border-radius:2px;background:#f7f7f7;line-height:1.21429em}div.prompt:empty{padding-top:0;padding-bottom:0}div.unrecognized_cell{padding:5px 5px 5px 0;display:-webkit-box;-webkit-box-orient:horizontal;display:-moz-box;-moz-box-orient:horizontal;display:box;box-orient:horizontal;box-align:stretch;display:flex;flex-direction:row;align-items:stretch}div.unrecognized_cell .inner_cell{border-radius:2px;padding:5px;font-weight:700;color:red;border:1px solid #cfcfcf;background:#eaeaea}div.unrecognized_cell .inner_cell a,div.unrecognized_cell .inner_cell a:hover{color:inherit;text-decoration:none}@media (max-width:540px){.prompt{text-align:left}div.unrecognized_cell>div.prompt{display:none}}div.code_cell{}div.input{page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;display:-moz-box;-moz-box-orient:horizontal;display:box;box-orient:horizontal;box-align:stretch;display:flex;flex-direction:row;align-items:stretch}@media (max-width:540px){div.input{-webkit-box-orient:vertical;-moz-box-orient:vertical;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}}div.input_prompt{color:navy;border-top:1px solid transparent}div.input_area>div.highlight{margin:.4em;border:none;padding:0;background-color:transparent}div.input_area>div.highlight>pre{margin:0;border:none;padding:0;background-color:transparent}.CodeMirror{line-height:1.21429em;font-size:14px;height:auto;background:0 0}.CodeMirror-scroll{overflow-y:hidden;overflow-x:auto}.CodeMirror-lines{padding:.4em}.CodeMirror-linenumber{padding:0 8px 0 4px}.CodeMirror-gutters{border-bottom-left-radius:2px;border-top-left-radius:2px}.CodeMirror pre{padding:0;border:0;border-radius:0}.highlight-base,.highlight-variable{}.highlight-variable-2{color:#1a1a1a}.highlight-variable-3{color:#333}.highlight-string{color:#<span class="caps">BA2121</span>}.highlight-comment{color:#408080;font-style:italic}.highlight-number{80}.highlight-atom{color:#88F}.highlight-keyword{color:green;font-weight:700}.highlight-builtin{color:green}.highlight-error{color:red}.highlight-operator{color:#<span class="caps">A2F</span>;font-weight:700}.highlight-meta{color:#<span class="caps">A2F</span>}.highlight-def{f}.highlight-string-2{color:#f50}.highlight-qualifier{color:#555}.highlight-bracket{color:#997}.highlight-tag{color:#170}.highlight-attribute{c}.highlight-header{f}.highlight-quote{90}.highlight-link{c}.cm-s-ipython span.cm-keyword{color:green;font-weight:700}.cm-s-ipython span.cm-atom{color:#88F}.cm-s-ipython span.cm-number{80}.cm-s-ipython span.cm-def{f}.cm-s-ipython span.cm-variable{}.cm-s-ipython span.cm-operator{color:#<span class="caps">A2F</span>;font-weight:700}.cm-s-ipython span.cm-variable-2{color:#1a1a1a}.cm-s-ipython span.cm-variable-3{color:#333}.cm-s-ipython span.cm-comment{color:#408080;font-style:italic}.cm-s-ipython span.cm-string{color:#<span class="caps">BA2121</span>}.cm-s-ipython span.cm-string-2{color:#f50}.cm-s-ipython span.cm-meta{color:#<span class="caps">A2F</span>}.cm-s-ipython span.cm-qualifier{color:#555}.cm-s-ipython span.cm-builtin{color:green}.cm-s-ipython span.cm-bracket{color:#997}.cm-s-ipython span.cm-tag{color:#170}.cm-s-ipython span.cm-attribute{c}.cm-s-ipython span.cm-header{f}.cm-s-ipython span.cm-quote{90}.cm-s-ipython span.cm-link{c}.cm-s-ipython span.cm-error{color:red}.cm-s-ipython span.cm-tab{background:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAMCAYAAAAkuj5RAAAAAXNSR0IArs4c6QAAAGFJREFUSMft1LsRQFAQheHPowAKoACx3IgEKtaEHujDjORSgWTH/ZOdnZOcM/sgk/kFFWY0qV8foQwS4MKBCS3qR6ixBJvElOobYAtivseIE120FaowJPN75GMu8j/LfMwNjh4HUpwg4LUAAAAASUVORK5CYII=')right no-repeat}div.output_wrapper{display:-webkit-box;-webkit-box-align:stretch;display:-moz-box;-moz-box-align:stretch;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch;z-index:1}div.output_scroll{height:24em;width:100%;overflow:auto;border-radius:2px;-webkit-box-shadow:inset 0 2px 8px rgba(0,0,0,.8);box-shadow:inset 0 2px 8px rgba(0,0,0,.8);display:block}div.output_collapsed{margin:0;padding:0;display:-webkit-box;-webkit-box-orient:vertical;display:-moz-box;-moz-box-orient:vertical;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}div.out_prompt_overlay{height:100%;padding:0 .4em;position:absolute;border-radius:2px}div.out_prompt_overlay:hover{-webkit-box-shadow:inset 0 0 1px #000;box-shadow:inset 0 0 1px #000;background:rgba(240,240,240,.5)}div.output_prompt{color:#8b0000}div.output_area{padding:0;page-break-inside:avoid;display:-webkit-box;-webkit-box-orient:horizontal;display:-moz-box;-moz-box-orient:horizontal;display:box;box-orient:horizontal;box-align:stretch;display:flex;flex-direction:row;align-items:stretch}div.output_area .MathJax_Display{text-align:left!important}div.output_area div.output_area img,div.output_area svg{max-width:100%;height:auto}div.output_area img.unconfined,div.output_area svg.unconfined{max-width:none}.output{display:-webkit-box;-webkit-box-orient:vertical;display:-moz-box;-moz-box-orient:vertical;display:box;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}@media (max-width:540px){div.output_area{-webkit-box-orient:vertical;-moz-box-orient:vertical;box-orient:vertical;box-align:stretch;display:flex;flex-direction:column;align-items:stretch}}div.output_area pre{margin:0;padding:0;border:0;vertical-align:baseline;background-color:transparent;border-radius:0}div.output_subarea{overflow-x:auto;padding:.4em;-webkit-box-flex:1;-moz-box-flex:1;box-flex:1;flex:1;max-width:calc(100% - 14ex)}div.output_text{text-align:left;line-height:1.21429em}div.output_stderr{background:#fdd}div.output_latex{text-align:left}div.output_javascript:empty{padding:0}.js-error{color:#8b0000}div.raw_input_container{font-family:monospace;padding-top:5px}span.raw_input_prompt{}input.raw_input{font-family:inherit;font-size:inherit;color:inherit;width:auto;vertical-align:baseline;padding:0 .25em;margin:0 .25em}input.raw_input:focus{box-shadow:none}p.p-space{margin-bottom:10px}div.output_unrecognized{padding:5px;font-weight:700;color:red}div.output_unrecognized a,div.output_unrecognized a:hover{color:inherit;text-decoration:none}.rendered_html{}.rendered_html :link,.rendered_html :visited,.rendered_html h1:first-child{margin-top:.538em}.rendered_html h2:first-child{margin-top:.636em}.rendered_html h3:first-child{margin-top:.777em}.rendered_html h4:first-child,.rendered_html h5:first-child,.rendered_html h6:first-child{margin-top:1em}.rendered_html *+ol,.rendered_html *+ul{margin-top:1em}.rendered_html *+table{margin-top:1em}.rendered_html *+p{margin-top:1em}.rendered_html *+img{margin-top:1em}div.text_cell{display:-webkit-box;-webkit-box-orient:horizontal;display:-moz-box;-moz-box-orient:horizontal;display:box;box-orient:horizontal;box-align:stretch;display:flex;flex-direction:row;align-items:stretch}@media (max-width:540px){div.text_cell>div.prompt{display:none}}div.text_cell_render{outline:0;resize:none;width:inherit;border-style:none;padding:.5em .5em .5em .4em;box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box}a.anchor-link:link{text-decoration:none;padding:0 20px;visibility:hidden}h1:hover .anchor-link,h2:hover .anchor-link,h3:hover .anchor-link,h4:hover .anchor-link,h5:hover .anchor-link,h6:hover .anchor-link{visibility:visible}.text_cell.rendered .input_area{display:none}.text_cell.rendered .text_cell.unrendered .text_cell_render{display:none}.cm-header-1,.cm-header-2,.cm-header-3,.cm-header-4,.cm-header-5,.cm-header-6{font-weight:700;font-family:"Helvetica Neue",Helvetica,Arial,sans-serif}.cm-header-1{font-size:185.7%}.cm-header-2{font-size:157.1%}.cm-header-3{font-size:128.6%}.cm-header-4{font-size:110%}.cm-header-5,.cm-header-6{font-size:100%;font-style:italic}</style>
<style type="text/css">.highlight .hll { background-color: #ffffcc }
.highlight  { background: #f8f8f8; }
.highlight .c { color: #408080; font-style: italic } /* Comment */
.highlight .err { border: 1px solid #<span class="caps">FF0000</span> } /* Error */
.highlight .k { color: #008000; font-weight: bold } /* Keyword */
.highlight .o { color: #666666 } /* Operator */
.highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.highlight .cp { color: #<span class="caps">BC7A00</span> } /* Comment.Preproc */
.highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
.highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
.highlight .gd { color: #A00000 } /* Generic.Deleted */
.highlight .ge { font-style: italic } /* Generic.Emph */
.highlight .gr { color: #<span class="caps">FF0000</span> } /* Generic.Error */
.highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.highlight .gi { color: #00A000 } /* Generic.Inserted */
.highlight .go { color: #888888 } /* Generic.Output */
.highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.highlight .gs { font-weight: bold } /* Generic.Strong */
.highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.highlight .gt { color: #<span class="caps">0044DD</span> } /* Generic.Traceback */
.highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: #008000 } /* Keyword.Pseudo */
.highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: #B00040 } /* Keyword.Type */
.highlight .m { color: #666666 } /* Literal.Number */
.highlight .s { color: #<span class="caps">BA2121</span> } /* Literal.String */
.highlight .na { color: #7D9029 } /* Name.Attribute */
.highlight .nb { color: #008000 } /* Name.Builtin */
.highlight .nc { color: #<span class="caps">0000FF</span>; font-weight: bold } /* Name.Class */
.highlight .no { color: #880000 } /* Name.Constant */
.highlight .nd { color: #<span class="caps">AA22FF</span> } /* Name.Decorator */
.highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
.highlight .ne { color: #<span class="caps">D2413A</span>; font-weight: bold } /* Name.Exception */
.highlight .nf { color: #<span class="caps">0000FF</span> } /* Name.Function */
.highlight .nl { color: #<span class="caps">A0A000</span> } /* Name.Label */
.highlight .nn { color: #<span class="caps">0000FF</span>; font-weight: bold } /* Name.Namespace */
.highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
.highlight .nv { color: #19177C } /* Name.Variable */
.highlight .ow { color: #<span class="caps">AA22FF</span>; font-weight: bold } /* Operator.Word */
.highlight .w { color: #bbbbbb } /* Text.Whitespace */
.highlight .mb { color: #666666 } /* Literal.Number.Bin */
.highlight .mf { color: #666666 } /* Literal.Number.Float */
.highlight .mh { color: #666666 } /* Literal.Number.Hex */
.highlight .mi { color: #666666 } /* Literal.Number.Integer */
.highlight .mo { color: #666666 } /* Literal.Number.Oct */
.highlight .sb { color: #<span class="caps">BA2121</span> } /* Literal.String.Backtick */
.highlight .sc { color: #<span class="caps">BA2121</span> } /* Literal.String.Char */
.highlight .sd { color: #<span class="caps">BA2121</span>; font-style: italic } /* Literal.String.Doc */
.highlight .s2 { color: #<span class="caps">BA2121</span> } /* Literal.String.Double */
.highlight .se { color: #<span class="caps">BB6622</span>; font-weight: bold } /* Literal.String.Escape */
.highlight .sh { color: #<span class="caps">BA2121</span> } /* Literal.String.Heredoc */
.highlight .si { color: #<span class="caps">BB6688</span>; font-weight: bold } /* Literal.String.Interpol */
.highlight .sx { color: #008000 } /* Literal.String.Other */
.highlight .sr { color: #<span class="caps">BB6688</span> } /* Literal.String.Regex */
.highlight .s1 { color: #<span class="caps">BA2121</span> } /* Literal.String.Single */
.highlight .ss { color: #19177C } /* Literal.String.Symbol */
.highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
.highlight .vc { color: #19177C } /* Name.Variable.Class */
.highlight .vg { color: #19177C } /* Name.Variable.Global */
.highlight .vi { color: #19177C } /* Name.Variable.Instance */
.highlight .il { color: #666666 } /* Literal.Number.Integer.Long */</style>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<blockquote><p><em>Premature optimization is the root of all&nbsp;evil.</em></p>
<div align="right"> Donald Knuth </div>
</blockquote>
<p>In this post, we&#8217;ll see how to optimize a python implementation of
the sliding-window burst search algorithm 
(<a href="http://dx.doi.org/10.1021/jp980965t">Fries 1998</a>). 
We will start <a href="#Finding-the-bottlenecks">profiling</a> the 
<a href="#A-pure-python-implementation">unoptimized code</a>, then we&#8217;ll explore 
different python optimization techniques. 
Sections of this post&nbsp;are:</p>
<ol>
<li><a href="#What-is-the-burst-search-algorithm?">What is the burst search&nbsp;algorithm?</a></li>
<li><a href="#Preparing-the-data">Preparing the&nbsp;data</a></li>
<li><a href="#A-pure-python-implementation">A pure-python&nbsp;implementation</a></li>
<li><a href="#Finding-the-bottlenecks">Finding the&nbsp;bottlenecks</a></li>
<li><a href="#Memoryview-in-pure-python">Memoryview in pure&nbsp;python</a> </li>
<li><a href="#Vectorizing-with-numpy">Vectorizing with&nbsp;numpy</a></li>
<li><a href="#Iterators-and-loop-unwrapping">Iterators and loop&nbsp;unwrapping</a></li>
<li><a href="#Beyond-pure-python:-Cython-and-Numba">Beyond pure python: Cython and&nbsp;Numba</a></li>
<li><a href="#Conclusion">Conclusions</a>.</li>
</ol>
<p>Why I choose python? Well arguments are too many, but you can find a nice summary 
in Jake Vanderplas&#8217; post
<a href="https://jakevdp.github.io/blog/2012/09/20/why-python-is-the-last/">Why Python is the Last Language You&#8217;ll Have To Learn</a>. 
In a single sentence (quoting <a href="http://www.johndcook.com/blog/2015/07/16/scientific-computing-in-python/">John Cook</a>):</p>
<blockquote><p>Iâ€™d rather do mathematics in a general programming language than do general programming in a mathematical&nbsp;language.</p>
</blockquote>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="What-is-the-burst-search-algorithm?">What is the burst search algorithm?<a class="anchor-link" href="#What-is-the-burst-search-algorithm?">&#182;</a></h1><p>To give some context, in the analysis of freely-diffusing single-molecule fluorescence experiments, 
the burst search algorithm is the central step that allows identifying 
bursts of photons emitted by single molecules during their diffusion
through a small excitation volume.
Here we use a simplified burst search that saves only start and stop times
of each burst. A complete real-world implementation can be found in
<a href="http://tritemio.github.io/FRETBursts/">FRETBursts</a>, a burst analysis 
software (relevant code <a href="https://github.com/tritemio/FRETBursts/blob/master/fretbursts/burstsearch/burstsearchlib.py#L63">here</a> and <a href="https://github.com/tritemio/FRETBursts/blob/master/fretbursts/burstsearch/burstsearchlib_c.pyx#L24">here</a>).</p>
<p>Briefly, a burst search algorithm tries to identifies bursts in a long stream 
of events. In single-molecule fluorescence experiments, this stream is
represented by photon arrival times (timestamps) with a resolution of a few&nbsp;nanoseconds.</p>
<p>A common algorithm, introduced by the Seidel group
(<a href="http://dx.doi.org/10.1021/jp980965t">Fries 1998</a>), consists in using a 
sliding windows of duration $T$ and identifying bursts when at least $m$ photons 
lie in this window.
The final step of selecting bursts by size (counts, or number of photons)
is computationally inexpensive and it will be ignored in this&nbsp;post.</p>
<p>Numerically, we need to &#8220;slide&#8221; the window in discrete steps, and since 
photon arrival times are stochastic, it makes sense to place
the windows start in correspondence with each timestamp $t_i$ and check 
if there are at least $m$ photons between $t_i$ and $t_i +&nbsp;T$.</p>
<p>But how can we &#8220;check if there are at least $m$ photons between 
$t_i$ and $t_i + T$&#8221;? In principle, we can count how many photons 
lie in the current time windows and start the burst if there are at least $m$. 
This would require, for each timestamp $t_i$, looping through a variable
number of timestamps ($n$), until $t_{i+n} - t_i >=T$ then check if 
$n >= m$. In total, we would loop through the full <code>timestamps</code> array many&nbsp;times.</p>
<p>Equivalently, we can loop over consecutive m-tuple of photons, and 
test if the time difference between the last and the first timestamp 
is $\le T$. This latter approach is much easier to implement and more
efficient as it requires looping through the <code>timestamps</code> exactly&nbsp;once.</p>
<p>For the sake of this post, we assume that each burst is characterized 
by only a start and stop time. Finally, since the number of bursts 
is not known in advance, we&#8217;ll use a list to collect the bursts
found during the&nbsp;search.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Preparing-the-data">Preparing the data<a class="anchor-link" href="#Preparing-the-data">&#182;</a></h1><p>To test different burst search implementation we can use a single-molecule <span class="caps">FRET</span> dataset <a href="http://figshare.com/articles/Example_smFRET_data_files_in_Photon_HDF5_format/1456362">available on figshare</a>. The file are in <a href="http://photon-hdf5.org">Photon-<span class="caps">HDF5</span></a>, so we can load its content with a <span class="caps">HDF5</span> library, such as <a href="http://www.pytables.org/">pytables</a>.</p>
<p>For this post we only need to load the <code>timestamps</code> array, which is here converted in&nbsp;seconds:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="kn">import</span> <span class="nn">tables</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;data/0023uLRpitc_NTP_20dT_0.5GndCl.hdf5&quot;</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">with</span> <span class="n">tables</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">h5file</span><span class="p">:</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">h5file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">photon_data</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="n">timestamps</span><span class="o">*</span><span class="n">h5file</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">photon_data</span><span class="o">.</span><span class="n">timestamps_specs</span><span class="o">.</span><span class="n">timestamps_unit</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">timestamps</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[4]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([  1.83558750e-03,   2.35056250e-03,   3.67655000e-03, ...,
         5.99998296e+02,   5.99998472e+02,   5.99999442e+02])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">timestamps</span><span class="o">.</span><span class="n">size</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[5]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>2683962</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="A-pure-python-implementation">A pure-python implementation<a class="anchor-link" href="#A-pure-python-implementation">&#182;</a></h1><p>The previously described algorithm can be expressed quite naturally with a&nbsp;for-loop:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">times</span><span class="p">[</span><span class="n">istart</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The code is straightforward to read. First note that <code>in_burst</code> is a 
state variable telling whether we are inside a burst.
With this in mind, the algorithm unfolds as&nbsp;follows:</p>
<ol>
<li>the $i$ variable loops over the timestamps&nbsp;index</li>
<li>if the $m$ consecutive photons starting at $t_i$ are within a window $\le T$<ol>
<li>if a burst is not already started, start the burst and save the start&nbsp;time</li>
</ol>
</li>
<li>Otherwise, if we are inside a burst, stop the burst and save the stop&nbsp;time</li>
</ol>
<p>Let&#8217;s run it. We will use typical values of <code>m=10</code> (use 10 photons to compute the 
rate) and $T=100\;{\rm\mu s}$ throughout this&nbsp;post.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_py</span> <span class="o">=</span> <span class="n">burst_search</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="nb">print</span><span class="p">(</span><span class="s">&#39;Number of bursts: &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bursts_py</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>Number of bursts:  18529
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">timeit</span> burst_search(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1 loops, best of 3: 1.02 s per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So, we found 18529 bursts and the execution took around a second. 
This can be &#8220;fast enough&#8221; in some cases. However, 
when dealing with larger files (longer measurement, multi-spot, etc&#8230;) 
or when we need to interactively explore the effect of burst search 
parameters we need a faster burst search. In this post
we just want to push the limits of what we can achieve in&nbsp;python.</p>
<p>Next sections show various optimization&nbsp;approaches.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Finding-the-bottlenecks">Finding the bottlenecks<a class="anchor-link" href="#Finding-the-bottlenecks">&#182;</a></h1><p>First step of any optimization is identifying the 
<a href="https://en.wikipedia.org/wiki/Bottleneck_(software">bottlenecks</a>. 
To measure the execution time we can use the <code>%prun</code> magic in IPython
which calls the standard python profiler and measures the time spent 
in each function call. In this case, however, a line-by-line measure 
would be more insightful. Therefore we will use 
<code>line_profiler</code>, a package available through <span class="caps">PIP</span> or conda.
For a more detailed overview of different profiling techniques
see the excellent post by Cyrille Rossant
<a href="http://cyrille.rossant.net/profiling-and-optimizing-python-code/">Profiling and optimizing Python code</a>.</p>
<p>Let&#8217;s run our function through <code>line_profiler</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">load_ext</span> line_profiler
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">lprun</span> -f burst_search burst_search(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     1                                           def burst_search(times, m, T):
     2         1            2      2.0      0.0      in_burst = False
     3         1            1      1.0      0.0      bursts = []
     4   2683952      1203389      0.4     25.9      for i in range(len(times) - m - 1):
     5   2683951      2247401      0.8     48.4          if times[i + m - 1] - times[i] &lt;= T:
     6    232747       106153      0.5      2.3              if not in_burst:
     7     18529         7966      0.4      0.2                  in_burst = True
     8     18529         8058      0.4      0.2                  istart = i
     9   2451204      1050190      0.4     22.6          elif in_burst:
    10     18529         8205      0.4      0.2              in_burst = False
    11     18529        16750      0.9      0.4              bursts.append((times[istart], times[i+m-1]))
    12         1            1      1.0      0.0      return bursts</code></pre>
<p>The most unexpected result, for me, was finding that the simple branching 
(e.g. line 9) accounts for a significant 20% of execution time.
Except for that, we see that looping over &gt;2 million of elements and 
computing <code>times[i+m] - times[i] &lt;= T</code> (line 5) at each cycle is where
the function spends the most time. The list-appending, conversely,
adds a negligible contribution since it is performed once per burst
(not at each&nbsp;cycle).</p>
<h1 id="Memoryview-in-pure-python">Memoryview in pure-python<a class="anchor-link" href="#Memoryview-in-pure-python">&#182;</a></h1><p>Numpy arrays are notoriously slow when accessed element by element.
Therefore a big portion of line 5 execution time may be due to numpy arrary indexing.
We can prove this by expanding line 5 in multiple lines to separate the element 
access from comparison and&nbsp;branching:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search_profile</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">rate_above_threshold</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span> <span class="o">&lt;=</span> <span class="n">T</span>
        <span class="k">if</span> <span class="n">rate_above_threshold</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">times</span><span class="p">[</span><span class="n">istart</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">lprun</span> -f burst_search_profile burst_search_profile(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>Line #      Hits         Time  Per Hit   % Time  Line Contents
==============================================================
     1                                           def burst_search_profile(times, m, T):
     2         1           20     20.0      0.0      in_burst = False
     3         1            1      1.0      0.0      bursts = []
     4   2683952      1303409      0.5     14.8      for i in range(len(times) - m - 1):
     5   2683951      1806225      0.7     20.5          t2 = times[i + m - 1]
     6   2683951      1526900      0.6     17.3          t1 = times[i]
     7   2683951      1607583      0.6     18.2          rate_above_threshold = t2 - t1 &lt;= T
     8   2683951      1284202      0.5     14.5          if rate_above_threshold:
     9    232747       111491      0.5      1.3              if not in_burst:
    10     18529         8883      0.5      0.1                  in_burst = True
    11     18529         8949      0.5      0.1                  istart = i
    12   2451204      1142937      0.5     12.9          elif in_burst:
    13     18529         8813      0.5      0.1              in_burst = False
    14     18529        20464      1.1      0.2              bursts.append((times[istart], times[i+m-1]))
    15         1            4      4.0      0.0      return bursts</code></pre>
<p>We see that the array element access (lines 5 and 6) accounts for almost 40%
of the total execution&nbsp;time.</p>
<p>A workaround for the slow element access is using a <code>memoryview</code>
(a <a href="https://docs.python.org/3.5/library/stdtypes.html#memory-views">built-in python object</a>)
to access the data in the numpy array.
Since a <code>memoryview</code> and a numpy array can shares data
we avoid wasting <span class="caps">RAM</span> and waiting for memory copying. 
To test  performances, we just call
<code>burst_search()</code> passing a memoryview instead of a numpy&nbsp;array:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">timeit</span> burst_search(memoryview(timestamps), 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1 loops, best of 3: 617 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This little trick alone provides more than 35% speed increase,
rendering the element access time negligible. Note that it is not
always possible to replace a numpy array with a <code>memoryview</code> because 
the latter does not support advanced numpy indexing and 
array&nbsp;operations.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Vectorizing-with-numpy">Vectorizing with numpy<a class="anchor-link" href="#Vectorizing-with-numpy">&#182;</a></h1><p>Even though we cannot completely remove the for-loop, we can
optimize the burst search function using numpy
vectorization and moving some heavy computation out of the&nbsp;loop.</p>
<p>As shown before, the bottleneck is the operation 
<code>t[i+m] - t[i] &lt;= T</code>. In particular the array element access 
at each cycle is quite&nbsp;heavy.</p>
<p>At a cost of a higher memory usage we can perform this subtraction 
outside the&nbsp;loop:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search_numpy1</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">delta_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[:</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">delta_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_numpy1</span> <span class="o">=</span> <span class="n">burst_search_numpy1</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">bursts_numpy1</span> <span class="o">==</span> <span class="n">bursts_py</span>
<span class="o">%</span><span class="k">timeit</span> burst_search_numpy1(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1 loops, best of 3: 436 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We achieved a ~2x speed improvement, not&nbsp;bad.</p>
<p>This approach can be improved moving also the comparison 
outside the&nbsp;loop:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search_numpy2</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">above_min_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[:</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">T</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">above_min_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_numpy2</span> <span class="o">=</span> <span class="n">burst_search_numpy2</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">bursts_numpy2</span> <span class="o">==</span> <span class="n">bursts_py</span>
<span class="o">%</span><span class="k">timeit</span> burst_search_numpy2(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1 loops, best of 3: 266 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The execution time is now 3 times faster that the intial one, but we can do&nbsp;better.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Iterators-and-loop-unwrapping">Iterators and loop unwrapping<a class="anchor-link" href="#Iterators-and-loop-unwrapping">&#182;</a></h1><p>The line profiler shows that the simple item access (line 6) takes 30% of the time.
This is not surprising because numpy has some overhead when accessing a single
element because of all the fancy indexing it supports. Since here we are simply
iterating over all the elements we can use the iterator to get the array&nbsp;elements.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search_numpy3</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">above_min_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[:</span><span class="n">max_index</span><span class="p">])</span> <span class="o">&lt;=</span> <span class="n">T</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">above_min_rate_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">above_min_rate</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">above_min_rate_</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_numpy3</span> <span class="o">=</span> <span class="n">burst_search_numpy3</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">bursts_numpy3</span> <span class="o">==</span> <span class="n">bursts_py</span>
<span class="o">%</span><span class="k">timeit</span> burst_search_numpy3(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1 loops, best of 3: 228 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can further optimize line 13, the <code>elif</code> branch that is executed at almost every cycle.
To avoid this test we can slightly unwrap the loop in this&nbsp;way:</p>
<ul>
<li>first we <code>continue</code> if not above the&nbsp;rate.</li>
<li>when &#8220;not continuing&#8221;, we are inside a burst and we do a mini internal loop until the burst is&nbsp;over</li>
<li>the main loop resumes from a position updated by the inner&nbsp;loop</li>
</ul>
<p>The trick is using the same iterator in the two nested&nbsp;loops:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search_numpy4</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">max_index</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">below_min_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">times</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[:</span><span class="n">max_index</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">T</span>
    
    <span class="n">iter_i_belowrate</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">((</span><span class="n">below_min_rate</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">below_min_rate_</span> <span class="ow">in</span> <span class="n">iter_i_belowrate</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">below_min_rate_</span><span class="p">:</span> <span class="k">continue</span>           
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">below_min_rate_</span> <span class="ow">in</span> <span class="n">iter_i_belowrate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">below_min_rate_</span><span class="p">:</span> <span class="k">break</span>
        
        <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_numpy4</span> <span class="o">=</span> <span class="n">burst_search_numpy4</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">bursts_numpy4</span> <span class="o">==</span> <span class="n">bursts_py</span>
<span class="o">%</span><span class="k">timeit</span> burst_search_numpy4(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1 loops, best of 3: 206 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>As a last attempt, we can try using a <code>memoryview</code> instead of a numpy array for
<code>below_min_rate</code>. With a <code>memoryview</code> the item access is fast so we can
use a simpler&nbsp;iterator:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">def</span> <span class="nf">burst_search_numpy5</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">below_min_rate</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">((</span><span class="n">times</span><span class="p">[</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[:</span><span class="n">times</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">T</span><span class="p">)</span>
    
    <span class="n">iter_i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_i</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">below_min_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">continue</span>
        
        <span class="n">start</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iter_i</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">below_min_rate</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="k">break</span>
        
        <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">start</span><span class="p">,</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_numpy5</span> <span class="o">=</span> <span class="n">burst_search_numpy5</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">bursts_numpy5</span> <span class="o">==</span> <span class="n">bursts_py</span>
<span class="o">%</span><span class="k">timeit</span> burst_search_numpy5(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>10 loops, best of 3: 191 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Optimizations 3-5 cut another 25-30% to the execution time,
achieving, overall, a 5 times faster execution (compared to the initial python version).
More than speed, I find this last version (<code>burst_search_numpy5</code>) the easiest to read, 
mainly because of the elimination of the state variable <code>in_burst</code>
and the use a simpler iterator. A rare case where optimization and
readability&nbsp;coincide.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Beyond-pure-python:-Cython-and-Numba">Beyond pure-python: Cython and Numba<a class="anchor-link" href="#Beyond-pure-python:-Cython-and-Numba">&#182;</a></h1><p>For faster execution we need to bypass the <a href="https://en.wikipedia.org/wiki/Interpreted_language">interpreted step</a>
of the python language. In cases like this, in which we perform an &#8220;hot&#8221; loop
with item access and branching inside the loop, we likely gain
a significant speed-up if the python code is&nbsp;compiled.</p>
<p>To compile the previous function to machine code we can use <a href="http://cython.org/">cython</a>.
Cython extends the python syntax, and allows to statically translate 
python to C (that, eventually, is compiled to machine code).<br>
To allow cython to produce an optimized C version, we need to specify 
the types of the variables used inside the&nbsp;loop.</p>
<p>The cython version of the previous algorithm&nbsp;is:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">load_ext</span> Cython
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%%</span><span class="n">cython</span>
<span class="k">cimport</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="k">def</span> <span class="nf">burst_search_cy</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64_t</span><span class="p">[:]</span> <span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int16_t</span> <span class="n">m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64_t</span> <span class="n">T</span><span class="p">):</span>
    <span class="k">cdef</span> <span class="kt">int</span> <span class="nf">i</span>
    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">int64_t</span> <span class="nf">istart</span>
    <span class="k">cdef</span> <span class="kt">np</span>.<span class="kt">uint8_t</span> <span class="nf">in_bursts</span>
    
    <span class="n">in_burst</span> <span class="o">=</span> <span class="mf">0</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="mf">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mf">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="mf">1</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="mf">0</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">times</span><span class="p">[</span><span class="n">istart</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mf">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In the IPython evironment (inside Jupyter), we use the <code>%%cython</code> 
<a href="https://ipython.org/ipython-doc/dev/interactive/tutorial.html">magic command</a> 
(included in the <code>cython</code> package) to compile the function on-fly.
Outside IPython, we can setup <code>distutils</code> (or <code>setuptools</code>) to handle the
compilation step (see <a href="http://docs.cython.org/">cython documentation</a>).</p>
<p>In addition to the import line, I added types definitions for 
the function arguments. The cython types have the same name as 
numpy types with and additional <code>_t</code>. For the first argument,
which is an array, I used the syntax <code>np.float64_t[:] times</code>
that defines a <a href="http://docs.cython.org/src/userguide/memoryviews.html">Cython Memoryview</a>
(like a python&#8217;s memoryview but faster).
To read more about memoryviews see this post from Jake Vanderplas: <a href="https://jakevdp.github.io/blog/2012/08/08/memoryview-benchmarks/">Memoryview Benchmarks</a>.</p>
<p>Let&#8217;s run the cython&nbsp;function:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_cy</span> <span class="o">=</span> <span class="n">burst_search_cy</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">assert</span> <span class="n">bursts_cy</span> <span class="o">==</span> <span class="n">bursts_py</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[29]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">timeit</span> burst_search_cy(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>100 loops, best of 3: 8.68 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Note that the execution time dropped to less than 10ms, a whooping 
100x speed increase compared to the pure python version. And all 
we have done is adding a few variable&nbsp;declarations!</p>
<p>Another optimization tool emerged in the last couple of years is 
<a href="http://numba.pydata.org/">Numba</a>. 
Numba is a <a href="https://en.wikipedia.org/wiki/Just-in-time_compilation">Just-in-Time</a> 
(<span class="caps">JIT</span>) compiler which analyzes code during execution and translates it 
to machine code on-fly. Under the hood, Numba uses the <a href="https://en.wikipedia.org/wiki/LLVM"><span class="caps">LLVM</span> compiler</a> 
for the translation to machine&nbsp;code.</p>
<p>In principle, numba can perform more advanced optimizations than 
cython and there are reports of 2x speed improvements 
vs cython in special&nbsp;cases.</p>
<p>Numba is even easier to use than cython: we just need to add a single 
line to <a href="https://realpython.com/blog/python/primer-on-python-decorators/">decorate</a> 
the function (i.e. <code>@numba.jit</code>). Let see Numba at&nbsp;work:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[30]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="kn">import</span> <span class="nn">numba</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[31]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="nd">@numba</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span> <span class="nf">burst_search_numba</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">T</span><span class="p">):</span>
    <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
    <span class="n">bursts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">istart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">times</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">T</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">in_burst</span><span class="p">:</span>
                <span class="n">in_burst</span> <span class="o">=</span> <span class="k">True</span>
                <span class="n">istart</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">elif</span> <span class="n">in_burst</span><span class="p">:</span>
            <span class="n">in_burst</span> <span class="o">=</span> <span class="k">False</span>
            <span class="n">bursts</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">times</span><span class="p">[</span><span class="n">istart</span><span class="p">],</span> <span class="n">times</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">bursts</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Differently from cython, numba code is just python code with no special&nbsp;syntax.</p>
<p>Checking the execution&nbsp;time:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[32]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="n">bursts_numba</span> <span class="o">=</span> <span class="n">burst_search_numba</span><span class="p">(</span><span class="n">timestamps</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[33]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="k">assert</span> <span class="n">bursts_numba</span> <span class="o">==</span> <span class="n">bursts_py</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span class="o">%</span><span class="k">timeit</span> burst_search_numba(timestamps, 10, 100e-6)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>100 loops, best of 3: 8.21 ms per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>we see that also the numba version runs in less than 10 ms 
(I would declare a tie with&nbsp;Cython).</p>
<p>As a small note, I had to add an additional line (<code>istart = 0</code>)
to help Numba infer the type of the <code>istart</code> variable. Knowing 
that <code>istart</code> is an int64, Numba can do more aggressive&nbsp;optimizations.</p>
<p>There are some corner cases which Numba cannot optimize, 
but these are becoming fewer at each release. 
For example in version 0.20, Numba was not able to optimize 
the current example (which then runs at pure-python speeds). 
Conversely, with the latest Numba version (0.22 as of writing), 
we reached pure-C speed, probably thanks to the 
<a href="http://numba.pydata.org/numba-doc/0.22.1/release-notes.html">new list optimizations</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">&#182;</a></h1><p>Starting from a pure-python implementation of the burst search, 
we used <code>line_profiler</code> to find the bottlenecks and optimized the&nbsp;code.</p>
<p>The burst search algorithm is not particularly keen to be vectorized. 
Nonetheless, using only pure-python tools (i.e. numpy vectorization, 
memoryview and iterators), we achieved a respectable 5x speed 
improvement. Next, using static compilation (Cython) or 
<span class="caps">JIT</span> compilation (Numba) we reached a 100x (100 fold!)&nbsp;speed-up.</p>
<p>With all these options for optimization in python, it can be easy 
to fall in the trap of premature optimization. To avoid it,
always perform optimizations as the last step, focusing on the 
bottlenecks highlighted by a profiler.
When in doubt, prefer clarity over&nbsp;speed.</p>
<h1 id="See-also">See also<a class="anchor-link" href="#See-also">&#182;</a></h1><ul>
<li><p><a href="http://tritemio.github.io/FRETBursts/">FRETBursts</a> A burst analysis 
software implementing the techniques illustrated in this post 
in a real-world&nbsp;scenario.</p>
</li>
<li><p><a href="http://cyrille.rossant.net/profiling-and-optimizing-python-code/">Cyrille Rossant: Profiling and optimizing Python&nbsp;code</a></p>
</li>
<li><p><a href="https://jakevdp.github.io/blog/2012/08/08/memoryview-benchmarks/">Jake Vanderplas: Memoryview&nbsp;Benchmarks</a></p>
</li>
</ul>
<blockquote><p>This post is written in Jupyter Notebook. The original notebook
can be downloaded <a href="https://github.com/tritemio/smbits/blob/master/content/2015-12/optimize-burst-search-python.ipynb">here</a>. Content released as <a href="https://creativecommons.org/licenses/by/2.0/"><span class="caps">CC</span> <span class="caps">BY</span> 2.0</a>.</p>
</blockquote>

</div>
</div>
</div>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: 'center'," +
        "    displayIndent: '0em'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['$','$'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'black ! important'} }" +
        "    } " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
<p>There are <a href="http://tritemio.github.io/smbits/2015/12/06/optimize-burst-search-python/#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="http://www.biophysics.org/">Biophysical Society</a></li>
                            <li><a href="http://planet.scipy.org/">Planet Scipy</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://twitter.com/tritemio_sc">Twitter</a></li>
                            <li><a href="http://github.com/tritemio">GitHub</a></li>
                            <li><a href="https://www.researchgate.net/profile/Antonino_Ingargiola">ResearchGate</a></li>
                            <li><a href="https://ucla.academia.edu/AntoninoIngargiola">Academia.edu</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'smbits';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>